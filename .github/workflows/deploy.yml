name: Deploy

on:
  workflow_run:
    workflows: ["Build"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      run_id:
        description: 'Build workflow run ID (optional)'
        required: false
        type: string

permissions:
  contents: read
  pull-requests: write
  actions: read

jobs:
  prepare:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    outputs:
      event_name: ${{ steps.meta.outputs.event_name }}
      ref: ${{ steps.meta.outputs.ref }}
      pr_number: ${{ steps.meta.outputs.pr_number }}
      sha: ${{ steps.meta.outputs.sha }}
      head_sha: ${{ steps.meta.outputs.head_sha }}
      is_production: ${{ steps.meta.outputs.is_production }}
      is_trunk: ${{ steps.meta.outputs.is_trunk }}
      is_pr: ${{ steps.meta.outputs.is_pr }}
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-${{ github.event.workflow_run.id }}
          path: ./artifacts
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Read metadata
        id: meta
        run: |
          EVENT_NAME=$(cat ./artifacts/build-meta/event_name)
          REF=$(cat ./artifacts/build-meta/ref)
          PR_NUMBER=$(cat ./artifacts/build-meta/pr_number)
          SHA=$(cat ./artifacts/build-meta/sha)
          HEAD_SHA=$(cat ./artifacts/build-meta/head_sha)

          echo "event_name=$EVENT_NAME" >> $GITHUB_OUTPUT
          echo "ref=$REF" >> $GITHUB_OUTPUT
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "sha=$SHA" >> $GITHUB_OUTPUT
          echo "head_sha=$HEAD_SHA" >> $GITHUB_OUTPUT

          # Determine deployment type
          if [[ "$REF" == "refs/heads/main" || "$REF" == "refs/heads/master" ]]; then
            echo "is_production=true" >> $GITHUB_OUTPUT
            echo "is_trunk=false" >> $GITHUB_OUTPUT
            echo "is_pr=false" >> $GITHUB_OUTPUT
          elif [[ "$REF" == "refs/heads/trunk" ]]; then
            echo "is_production=false" >> $GITHUB_OUTPUT
            echo "is_trunk=true" >> $GITHUB_OUTPUT
            echo "is_pr=false" >> $GITHUB_OUTPUT
          elif [[ "$EVENT_NAME" == "pull_request" ]]; then
            echo "is_production=false" >> $GITHUB_OUTPUT
            echo "is_trunk=false" >> $GITHUB_OUTPUT
            echo "is_pr=true" >> $GITHUB_OUTPUT
          else
            echo "is_production=false" >> $GITHUB_OUTPUT
            echo "is_trunk=false" >> $GITHUB_OUTPUT
            echo "is_pr=false" >> $GITHUB_OUTPUT
          fi

  deploy:
    needs: prepare
    runs-on: ubuntu-latest
    environment:
      name: ${{ needs.prepare.outputs.is_production == 'true' && 'production' || needs.prepare.outputs.is_trunk == 'true' && 'preview-trunk' || format('preview-pr-{0}', needs.prepare.outputs.pr_number) }}
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.head_sha }}
          fetch-depth: 0

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-${{ github.event.workflow_run.id }}
          path: ./artifacts
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Set up Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: 1.3.6

      - name: Install dependencies
        run: bun install

      - name: Restore build artifacts
        run: |
          cp -r ./artifacts/dist ./dist
          cp -r ./artifacts/server/dist ./server/dist 2>/dev/null || true
          echo "Checking build artifacts..."
          ls -la ./dist/client/ || echo "No client dist found"
          ls -la ./server/dist/ || echo "No server dist found"

      - name: Determine deployment config
        id: config
        env:
          # Repository-level variables (available before environment is set)
          REPO_NAME: ${{ vars.NAME }}
          REPO_DESCRIPTION: ${{ vars.DESCRIPTION }}
          REPO_AVATAR: ${{ vars.AVATAR }}
          REPO_PAGE_SIZE: ${{ vars.PAGE_SIZE }}
          REPO_RSS_ENABLE: ${{ vars.RSS_ENABLE }}
          REPO_WORKER_NAME: ${{ vars.WORKER_NAME }}
          REPO_DB_NAME: ${{ vars.DB_NAME }}
        run: |
          if [[ "${{ needs.prepare.outputs.is_production }}" == "true" ]]; then
            echo "worker_name=${REPO_WORKER_NAME:-rin-server}" >> $GITHUB_OUTPUT
            echo "db_name=${REPO_DB_NAME:-rin}" >> $GITHUB_OUTPUT
            echo "name=${REPO_NAME:-Rin}" >> $GITHUB_OUTPUT
          elif [[ "${{ needs.prepare.outputs.is_trunk }}" == "true" ]]; then
            echo "worker_name=${REPO_WORKER_NAME:-rin-server}-trunk" >> $GITHUB_OUTPUT
            echo "db_name=${REPO_DB_NAME:-rin}-trunk" >> $GITHUB_OUTPUT
            echo "name=${REPO_NAME:-Rin} (Trunk Preview)" >> $GITHUB_OUTPUT
          else
            echo "worker_name=${REPO_WORKER_NAME:-rin-server}-pr-${{ needs.prepare.outputs.pr_number }}" >> $GITHUB_OUTPUT
            echo "db_name=${REPO_DB_NAME:-rin}-pr-${{ needs.prepare.outputs.pr_number }}" >> $GITHUB_OUTPUT
            echo "name=${REPO_NAME:-Rin} (PR #${{ needs.prepare.outputs.pr_number }})" >> $GITHUB_OUTPUT
          fi
          # Output repository-level vars for use in deploy step
          echo "description=${REPO_DESCRIPTION}" >> $GITHUB_OUTPUT
          echo "avatar=${REPO_AVATAR}" >> $GITHUB_OUTPUT
          echo "page_size=${REPO_PAGE_SIZE}" >> $GITHUB_OUTPUT
          echo "rss_enable=${REPO_RSS_ENABLE}" >> $GITHUB_OUTPUT

      - name: Deploy to Cloudflare
        id: deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          WORKER_NAME: ${{ steps.config.outputs.worker_name }}
          DB_NAME: ${{ steps.config.outputs.db_name }}
          NAME: ${{ steps.config.outputs.name }}
          DESCRIPTION: ${{ steps.config.outputs.description || 'A lightweight personal blogging system' }}
          AVATAR: ${{ steps.config.outputs.avatar || '' }}
          PAGE_SIZE: ${{ steps.config.outputs.page_size || '5' }}
          RSS_ENABLE: ${{ steps.config.outputs.rss_enable || 'false' }}
          R2_BUCKET_NAME: ${{ vars.R2_BUCKET_NAME || '' }}
          S3_ENDPOINT: ${{ secrets.S3_ENDPOINT || '' }}
          S3_ACCESS_HOST: ${{ secrets.S3_ACCESS_HOST || '' }}
          S3_BUCKET: ${{ secrets.S3_BUCKET || '' }}
          S3_ACCESS_KEY_ID: ${{ secrets.S3_ACCESS_KEY_ID || '' }}
          S3_SECRET_ACCESS_KEY: ${{ secrets.S3_SECRET_ACCESS_KEY || '' }}
          RIN_GITHUB_CLIENT_ID: ${{ secrets.RIN_GITHUB_CLIENT_ID || '' }}
          RIN_GITHUB_CLIENT_SECRET: ${{ secrets.RIN_GITHUB_CLIENT_SECRET || '' }}
          ADMIN_USERNAME: ${{ secrets.ADMIN_USERNAME }}
          ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
          JWT_SECRET: ${{ secrets.JWT_SECRET || '' }}
          WEBHOOK_URL: ${{ vars.WEBHOOK_URL || '' }}
          RSS_TITLE: ${{ vars.RSS_TITLE || '' }}
          RSS_DESCRIPTION: ${{ vars.RSS_DESCRIPTION || '' }}
        run: |
          bun run deploy
          echo "url=https://${WORKER_NAME}.${{ secrets.CLOUDFLARE_ACCOUNT_ID }}.workers.dev" >> $GITHUB_OUTPUT

      - name: Comment deployment URL
        if: ${{ needs.prepare.outputs.is_pr == 'true' }}
        uses: actions/github-script@v7
        with:
          script: |
            const url = '${{ steps.deploy.outputs.url }}';
            const prNumber = parseInt('${{ needs.prepare.outputs.pr_number }}');

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' && comment.body.includes('Preview Deployed')
            );

            const body = `ðŸš€ **Preview Deployed!**\n\n- URL: ${url}\n\n*This preview will be automatically updated when you push new commits.*`;

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body
              });
            }