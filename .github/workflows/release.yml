name: Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+*'

permissions:
  contents: write

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Set up Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: 1.3.6

      - name: Install dependencies
        run: bun install

      - name: Validate version consistency
        run: |
          TAG_VERSION=${GITHUB_REF#refs/tags/v}
          PKG_VERSION=$(cat package.json | grep '"version"' | head -1 | awk -F: '{ print $2 }' | sed 's/[",]//g' | tr -d '[[:space:]]')
          
          echo "Tag version: $TAG_VERSION"
          echo "Package version: $PKG_VERSION"
          
          if [ "$TAG_VERSION" != "$PKG_VERSION" ]; then
            echo "‚ùå Version mismatch: tag is v$TAG_VERSION but package.json is $PKG_VERSION"
            exit 1
          fi
          
          echo "‚úÖ Version consistency check passed"

      - name: Run typecheck
        run: bun run check

      - name: Setup Wrangler
        uses: ./.github/actions/setup-wrangler
        with:
          mode: 'dry-run'

      - name: Run build
        run: bun run build

  build:
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: 1.3.6

      - name: Install dependencies
        run: bun install

      - name: Setup Wrangler
        uses: ./.github/actions/setup-wrangler
        with:
          mode: 'dry-run'

      # Note: vite.config.ts builds directly to ../dist/client
      - name: Build client
        run: |
          cd client
          bun run build
          cd ..

      - name: Build server
        run: |
          mkdir -p ./dist/server
          bunx wrangler deploy --dry-run --outdir=dist/server

      - name: Package build artifacts
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          tar -czf "build-v${VERSION}-cloudflare.tar.gz" dist/
          echo "Artifact packaged: build-v${VERSION}-cloudflare.tar.gz"
          ls -lh build-v*.tar.gz

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-release
          path: build-v*-cloudflare.tar.gz

  create-release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-release
          path: ./

      - name: Generate release notes
        id: release_notes
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
          
          echo "## What's Changed" > release_notes.md
          echo "" >> release_notes.md
          
          if [ -z "$PREVIOUS_TAG" ]; then
            echo "This is the first release! üéâ" >> release_notes.md
            COMMIT_RANGE="HEAD"
          else
            echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/${PREVIOUS_TAG}...v${VERSION}" >> release_notes.md
            echo "" >> release_notes.md
            COMMIT_RANGE="${PREVIOUS_TAG}..HEAD"
          fi
          
          # Categorize commits
          FEATURES=$(git log $COMMIT_RANGE --pretty=format:"- %s (%h)" --grep="^feat" 2>/dev/null || true)
          FIXES=$(git log $COMMIT_RANGE --pretty=format:"- %s (%h)" --grep="^fix" 2>/dev/null || true)
          DOCS=$(git log $COMMIT_RANGE --pretty=format:"- %s (%h)" --grep="^docs" 2>/dev/null || true)
          REFACTOR=$(git log $COMMIT_RANGE --pretty=format:"- %s (%h)" --grep="^refactor" 2>/dev/null || true)
          PERF=$(git log $COMMIT_RANGE --pretty=format:"- %s (%h)" --grep="^perf" 2>/dev/null || true)
          OTHER=$(git log $COMMIT_RANGE --pretty=format:"- %s (%h)" --grep="^\(feat\\|fix\\|docs\\|refactor\\|perf\)" --invert-grep 2>/dev/null || true)
          
          if [ -n "$FEATURES" ]; then
            echo "### üöÄ Features" >> release_notes.md
            echo "$FEATURES" | sed 's/^feat(\([^)]*\)):/\1:/' | sed 's/^feat:/‚ú®:/' >> release_notes.md
            echo "" >> release_notes.md
          fi
          
          if [ -n "$FIXES" ]; then
            echo "### üêõ Bug Fixes" >> release_notes.md
            echo "$FIXES" | sed 's/^fix(\([^)]*\)):/\1:/' | sed 's/^fix:/üêõ:/' >> release_notes.md
            echo "" >> release_notes.md
          fi
          
          if [ -n "$PERF" ]; then
            echo "### ‚ö° Performance" >> release_notes.md
            echo "$PERF" | sed 's/^perf(\([^)]*\)):/\1:/' | sed 's/^perf:/‚ö°:/' >> release_notes.md
            echo "" >> release_notes.md
          fi
          
          if [ -n "$REFACTOR" ]; then
            echo "### ‚ôªÔ∏è Refactoring" >> release_notes.md
            echo "$REFACTOR" | sed 's/^refactor(\([^)]*\)):/\1:/' | sed 's/^refactor:/‚ôªÔ∏è:/' >> release_notes.md
            echo "" >> release_notes.md
          fi
          
          if [ -n "$DOCS" ]; then
            echo "### üìö Documentation" >> release_notes.md
            echo "$DOCS" | sed 's/^docs(\([^)]*\)):/\1:/' | sed 's/^docs:/üìö:/' >> release_notes.md
            echo "" >> release_notes.md
          fi
          
          if [ -n "$OTHER" ]; then
            echo "### üìù Other Changes" >> release_notes.md
            echo "$OTHER" >> release_notes.md
            echo "" >> release_notes.md
          fi
          
          # Add manual CHANGELOG section if exists
          if [ -f CHANGELOG.md ]; then
            CHANGELOG_SECTION=$(awk "/^## \[v${VERSION}\]/ {flag=1; next} /^## \[/ {flag=0} flag" CHANGELOG.md)
            if [ -n "$CHANGELOG_SECTION" ]; then
              echo "" >> release_notes.md
              echo "---" >> release_notes.md
              echo "" >> release_notes.md
              echo "## üìã Detailed Changelog" >> release_notes.md
              echo "" >> release_notes.md
              echo "$CHANGELOG_SECTION" >> release_notes.md
            fi
          fi
          
          # Add upgrade guide
          echo "" >> release_notes.md
          echo "---" >> release_notes.md
          echo "" >> release_notes.md
          echo "## üÜô Upgrade Guide" >> release_notes.md
          echo "" >> release_notes.md
          echo "For users who have forked this repository:" >> release_notes.md
          echo "" >> release_notes.md
          echo "1. Go to your forked repository on GitHub" >> release_notes.md
          echo '2. Click **"Sync fork"** to get the latest changes' >> release_notes.md
          echo "3. Review the [CHANGELOG.md](./CHANGELOG.md) for migration steps" >> release_notes.md
          echo "4. Update your environment variables if needed" >> release_notes.md
          echo "5. The deployment will run automatically" >> release_notes.md
          
          # Output for GitHub Actions
          NOTES=$(cat release_notes.md)
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Also output to console for debugging
          echo "Generated release notes:"
          cat release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          body_path: release_notes.md
          files: build-v*-cloudflare.tar.gz
          draft: false
          prerelease: ${{ contains(github.ref, '-') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify:
    needs: create-release
    runs-on: ubuntu-latest
    if: failure()
    steps:
      - name: Notify on failure
        run: |
          echo "‚ùå Release workflow failed for ${{ github.ref }}"
          echo "Please check the workflow logs for details."
