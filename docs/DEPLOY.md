# éƒ¨ç½²

## å…¶ä»–æ–‡æ¡£
[ç¯å¢ƒå˜é‡åˆ—è¡¨](./ENV.md)

>[!TIP]
> ä¸‹æ–‡ä»£ç å—ä¸­è‹¥å‡ºç°å½¢å¦‚ <æ–‡å­—> çš„å†…å®¹è¡¨ç¤ºéœ€è¦æ ¹æ®æ–‡å­—æç¤ºæ›¿æ¢ä¸ºè‡ªå·±çš„å†…å®¹ï¼ˆ`<`å’Œ`>`ä¸è¦ä¿ç•™ï¼‰ï¼Œå¦‚ï¼š
> ```
> bun wrangler d1 create <æ•°æ®åº“åç§°>
> ```
> è¡¨ç¤ºå°† <æ•°æ®åº“åç§°> æ›¿æ¢ä¸ºä½ å–œæ¬¢çš„åç§°ï¼Œè¿™é‡Œä½¿ç”¨ rinæ›¿æ¢ï¼š
> ```
> bun wrangler d1 create rin
> ```
> è¿™å°±æ˜¯æœ€ç»ˆçš„å‘½ä»¤


æ‰“å¼€ä»“åº“é¡µé¢ï¼šhttps://github.com/OXeu/Rin
## Fork 
ç‚¹å‡» Fork æŒ‰é’® fork å‡ºä¸€ä¸ªæ–°ä»“åº“
![1000000657](https://github.com/OXeu/Rin/assets/36541432/df3607ca-a8a9-49b8-92ce-6b348afeb13f)


## å‰ç«¯
ç™»å½• [Cloudflare](https://dash.cloudflare.com) æ§åˆ¶å°ï¼Œè¿›å…¥ `Workers å’Œ Pages` é¡µé¢ï¼Œç‚¹å‡»`åˆ›å»ºåº”ç”¨ç¨‹åº`ï¼Œé€‰æ‹© Pages

![1000000658](https://github.com/OXeu/Rin/assets/36541432/35d4f9e3-3af3-4ec8-8060-2a352f4d51ae)

ç‚¹å‡»è¿æ¥åˆ° Git è¿æ¥è‡ªå·±çš„ Github è´¦å·å¹¶é€‰æ‹© Fork çš„å­˜å‚¨åº“

![1000000666](https://github.com/OXeu/Rin/assets/36541432/e3b6da75-1a5f-46ec-9820-636cc5238023)


ç‚¹å‡» `å¼€å§‹è®¾ç½®` è¿›å…¥é…ç½®é¡µé¢ï¼š

æ„å»ºè®¾ç½®æŒ‰ç…§å¡«å…¥ä»¥ä¸‹å†…å®¹ï¼š
```
æ¡†æ¶é¢„è®¾ï¼šæ— 
æ„å»ºå‘½ä»¤ï¼šbun b
æ„å»ºè¾“å‡ºç›®å½•ï¼šclient/dist
è·¯å¾„ï¼š<ç•™ç©º>
```
![1000000659](https://github.com/OXeu/Rin/assets/36541432/98fb3021-932b-4bfa-8118-3378f98ff628)


ç¯å¢ƒå˜é‡å¤åˆ¶ä»¥ä¸‹å†…å®¹ï¼Œæ ¹æ®è‡ªèº«æƒ…å†µä¿®æ”¹å˜é‡å€¼ï¼š
>[!IMPORTANT]
æœ€åä¸¤è¡Œç¯å¢ƒå˜é‡ `SKIP_DEPENDENCY_INSTALL` å’Œ `UNSTABLE_PRE_BUILD` ä¸ºé…ç½® Cloudflare ä½¿ç”¨ Bun è¿›è¡Œæ„å»ºçš„å‚æ•°ï¼Œä¸è¦ä¿®æ”¹
```ini
NAME=Xeu # æ˜µç§°ï¼Œæ˜¾ç¤ºåœ¨å·¦ä¸Šè§’
DESCRIPTION=æ‚é£ŸåŠ¨ç‰© # ä¸ªäººæè¿°ï¼Œæ˜¾ç¤ºåœ¨å·¦ä¸Šè§’æ˜µç§°ä¸‹æ–¹
AVATAR=https://avatars.githubusercontent.com/u/36541432 # å¤´åƒåœ°å€ï¼Œæ˜¾ç¤ºåœ¨å·¦ä¸Šè§’
API_URL=https://rin.xeu.life # æœåŠ¡ç«¯åŸŸåï¼Œå¯ä»¥å…ˆç•™ç©ºåé¢å†æ”¹
SKIP_DEPENDENCY_INSTALL=true
UNSTABLE_PRE_BUILD=asdf install bun latest && asdf global bun latest && bun i
```
![1000000660](https://github.com/OXeu/Rin/assets/36541432/0fe9276f-e16f-4b8a-87c5-14de582c9a3a)


ç‚¹å‡»`ä¿å­˜å¹¶éƒ¨ç½²`ï¼Œç­‰å¾…æ„å»ºéƒ¨ç½²ï¼Œä¸å‡ºæ„å¤–çš„è¯çº¦ 30s åå³å¯éƒ¨ç½²å®Œæˆï¼š

![1000000661](https://github.com/OXeu/Rin/assets/36541432/979810b7-3f6f-415b-a8e8-5b08b0da905d)


ç‚¹å‡»æ‰“å¼€å³å¯çœ‹è§å‰ç«¯é¡µé¢

![1000000662](https://github.com/OXeu/Rin/assets/36541432/57c61ad6-c324-48e4-a28f-a1708fd7d41a)


å‰ç«¯å°±å…¨éƒ¨éƒ¨ç½²å®Œæˆå•¦ğŸ‰

åç»­å¯ä»¥åœ¨ Pages çš„è®¾ç½®ä¸­å†æ¬¡ä¿®æ”¹ç¯å¢ƒå˜é‡ä»¥åŠé…ç½®åŸŸå

ä½†æ˜¯ç°åœ¨é¡µé¢ä¸­ä»€ä¹ˆå†…å®¹ä¹Ÿæ²¡æœ‰ï¼Œå› ä¸ºæˆ‘ä»¬è¿˜æ²¡æœ‰å¼€å§‹éƒ¨ç½²åç«¯

## åç«¯

åç«¯éƒ¨ç½²æ¯”è¾ƒç¹çï¼Œä½†ç»è¿‡å‡ æ¬¡çš„ä¼˜åŒ–éƒ¨ç½²æµç¨‹ï¼Œç°åœ¨å·²ç»å¤§å¤§ç®€åŒ–äº†

### è·å–ç”¨æˆ· ID ä¸ API ä»¤ç‰Œ
å‚ç…§ https://developers.cloudflare.com/workers/wrangler/ci-cd/ æ¥é…ç½® Github Actions æ‰€éœ€çš„ Cloudflare ç™»å½•ç¯å¢ƒå˜é‡

ID éšæ„ç‚¹å‡»ä¸€ä¸ªè‡ªå·±ç»‘å®šçš„åŸŸåï¼Œè¿›å…¥ååœ¨å³ä¾§ï¼ˆéœ€è¦å‘ä¸‹æ»‘åŠ¨ä¸€æ®µè·ç¦»ï¼‰å¯ä»¥æ‰¾åˆ°`è´¦æˆ·ID`

åˆ›å»º API ä»¤ç‰Œï¼šç‚¹å‡»å³ä¸Šè§’`å¤´åƒ` > `æˆ‘çš„ä¸ªäººèµ„æ–™` > `API ä»¤ç‰Œ` > `åˆ›å»ºä»¤ç‰Œ`ï¼Œæ¨¡æ¿é€‰æ‹©`ç¼–è¾‘ Cloudflare Workers`ï¼š
![1000000663](https://github.com/OXeu/Rin/assets/36541432/3a34a2ad-b993-47fe-965d-31cca4a8e92a)


åˆ›å»ºå®Œæˆåä¿å­˜ä»¤ç‰Œ

### é…ç½® Github Action

åœ¨è‡ªå·± fork çš„ä»“åº“ä¸­ > `Settings` > `Secrets and Variables` > `Actions` > `Repository secrets` ç‚¹å‡» `New repository secret` åˆ›å»ºä»¥ä¸‹ä¸¤ä¸ªå¯†é’¥ï¼š

```
CLOUDFLARE_ACCOUNT_ID=<ä½ çš„ç”¨æˆ·ID>
CLOUDFLARE_API_TOKEN=<ä½ çš„ä»¤ç‰Œ>
```
åŒæ—¶ä½ å¯ä»¥åœ¨`Actions secrets and variables`çš„ `Variables` ä¸­åˆ›å»ºä»¥ä¸‹å˜é‡ï¼š
```ini
DB_NAME=<æ•°æ®åº“åç§°ï¼Œé»˜è®¤rin>
WORKER_NAME=<Cloudflare Worker åç§°ï¼Œé»˜è®¤rin-server>
FRONTEND_URL=<å‰ç«¯åœ°å€ï¼Œç”¨äºWebhooké€šçŸ¥æ—¶æ‹¼æ¥åœ°å€ï¼Œå¯ä¸å¡«>
S3_FOLDER=<S3 å›¾ç‰‡èµ„æºå­˜å‚¨çš„æ–‡ä»¶å¤¹ï¼Œé»˜è®¤ä¸ºimages/>
```

å®Œæˆå‡†å¤‡å·¥ä½œä»¥åå³å¯åœ¨ Github Action ä¸­æ‰‹åŠ¨è§¦å‘ä¸€æ¬¡ Workflowï¼Œä¸€åˆ‡æ­£å¸¸çš„è¯å¾ˆå¿«å°±èƒ½éƒ¨ç½²å®Œæˆ

è¿™æ ·æœåŠ¡ç«¯å°±éƒ¨ç½²å¥½äº†ï¼Œä½†æ˜¯æˆ‘ä»¬è¿˜éœ€è¦é…ç½® Github OAuthç”¨äºç™»å½•å’Œ S3 å­˜å‚¨ç”¨äºå­˜å‚¨å›¾ç‰‡


å›åˆ° Cloudflare é¢æ¿é…ç½®åç«¯åŸŸåä¸ä¸€äº›æ•æ„Ÿçš„ç¯å¢ƒå˜é‡

åœ¨ `è®¾ç½®` > `è§¦å‘å™¨` > `è‡ªå®šä¹‰åŸŸ` å¤„å¯ä»¥è‡ªå®šä¹‰åç«¯çš„åŸŸåï¼Œé»˜è®¤ä¹Ÿæœ‰åˆ†é…ä¸€ä¸ª`workers.dev`çš„åŸŸå

åœ¨ `è®¾ç½®` > `å˜é‡` > `ç¯å¢ƒå˜é‡` å¤„ç¼–è¾‘å˜é‡ï¼Œç‚¹å‡»æ·»åŠ å˜é‡ï¼Œå¤åˆ¶ç²˜è´´ä»¥ä¸‹å†…å®¹è‡³å˜é‡åå¤„å³å¯è‡ªåŠ¨æ·»åŠ ä¸Šæ‰€æœ‰ç¯å¢ƒå˜é‡ï¼Œä¹‹åå†æ ¹æ®è‡ªå·±çš„å…·ä½“é…ç½®ä¿®æ”¹å˜é‡å€¼ï¼š
```
GITHUB_CLIENT_ID=YourGithubClientID
GITHUB_CLIENT_SECRET=YourGithubClientSecret
JWT_SECRET=YourJWTSecret
S3_BUCKET=YourBucketName
S3_REGION=YourRegion
S3_ENDPOINT=YourEndpoint
S3_ACCESS_HOST=YourAccessHost
S3_ACCESS_KEY_ID=YourAccessKeyID
S3_SECRET_ACCESS_KEY=YourSecretAccessKey
```

## æ¥å…¥ Github OAuth

æ‰“å¼€ <https://github.com/settings/developers>ï¼Œé€‰æ‹© `New OAuth App` åˆ›å»ºä¸€ä¸ªæ–°çš„ Oauth Appï¼Œå¡«å…¥è‡ªå·±çš„åº”ç”¨åç§°ä¸ä¸»é¡µåœ°å€(å¸¦`http://`æˆ–`https://`)ï¼Œ`Authorization callback URL` å¡«å†™

```
https://<ä½ çš„åç«¯åœ°å€>/user/github/callback
```

è¿™é‡Œé™„ä¸Šæˆ‘çš„å‚æ•° 
![Github OAuth é…ç½®](https://github.com/OXeu/Rin/assets/36541432/74ab8d16-93ca-4919-beec-4beb7a2003a6)




éšåé…ç½®ç¯å¢ƒå˜é‡ä¸­ OAuth éƒ¨åˆ† 

ä»¥ä¸‹æ˜¯å…·ä½“çš„é…ç½®ï¼Œ`GITHUB_CLIENT_ID`å¡«å†™ Github OAuth App ä¸­çš„`Client ID`,`GITHUB_CLIENT_SECRET`å¡«å†™åœ¨ Github OAuth App ç‚¹å‡» `Generate a new client secret` åçš„ `Client secret`ï¼Œæ³¨æ„æ¯æ¬¡åˆ›å»ºååªå±•ç¤ºä¸€æ¬¡ï¼Œåç»­æ— æ³•æŸ¥çœ‹ï¼Œå¦‚æœä¸æ…ä¸¢å¤±é‡æ–°ç”Ÿæˆä¸€ä¸ªæ–°çš„å³å¯

## åˆ›å»º R2 æ¡¶

ç†è®ºä¸Šæ”¯æŒä»»æ„éµå¾ª S3 åè®®çš„å¯¹è±¡å­˜å‚¨æœåŠ¡ï¼Œè¿™é‡Œåªä»‹ç»æ¥å…¥ Cloudflare R2 çš„æ“ä½œ

Cloudflare é¢æ¿ä¸­ç‚¹å‡» `R2` > `åˆ›å»ºå­˜å‚¨æ¡¶`ï¼Œå¡«å†™åç§°ï¼Œé€‰æ‹©è·ç¦»è‡ªå·±è¿‘çš„ä½ç½®ï¼š
![1000000665](https://github.com/OXeu/Rin/assets/36541432/17c5ad7b-8a3a-49b2-845a-8d043484aa63)


åˆ›å»ºå­˜å‚¨æ¡¶ä¹‹åè¿›å…¥å­˜å‚¨æ¡¶è¯¦æƒ…é¡µ > `è®¾ç½®`ï¼Œå¤åˆ¶ S3 API åœ°å€ï¼Œå»é™¤æœ«å°¾çš„å­˜å‚¨æ¡¶åç§°åå¡«å…¥ `S3_ENDPOINT`ï¼Œå¦‚ï¼š
```ini
S3_BUCKET=image # æ¡¶åç§°
S3_REGION=auto # åœ°åŒº auto ä¸ç”¨ä¿®æ”¹
S3_ENDPOINT=https://8879900e5e1219fb745c9f69b086565a.r2.cloudflarestorage.com
```
ç„¶ååœ¨`å…¬å¼€è®¿é—®`å¤„ç»‘å®šä¸€ä¸ªåŸŸåç”¨äºè®¿é—®èµ„æºï¼Œç»‘å®šçš„åŸŸåå¯¹åº”äº`S3_ACCESS_HOST`ç¯å¢ƒå˜é‡ï¼š
```ini
S3_ACCESS_HOST=https://image.xeu.life
```
ç„¶ååˆ›å»ºä¸€ä¸ª API ä»¤ç‰Œç”¨äºè®¿é—®å­˜å‚¨æ¡¶ï¼Œå¯å‚è€ƒ https://developers.cloudflare.com/r2/api/s3/tokens/ ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ï¼Œæ‹¿åˆ° ID å’Œ TOKEN å¯¹åº”äº`S3_ACCESS_KEY_ID` å’Œ `S3_SECRET_ACCESS_KEY` å˜é‡ï¼Œå¡«å…¥ Workers çš„ç¯å¢ƒå˜é‡ä¸­

è‡³æ­¤åç«¯å°±å·²ç»éƒ¨ç½²å®Œæˆäº†ï¼Œè®°å¾—å°†å‰ç«¯çš„ API_URL ä¿®æ”¹ä¸ºåç«¯çš„åœ°å€ï¼Œä¸æ­¤åŒæ—¶ï¼Œå¦‚æœä½ éœ€è¦ WebHook é€šçŸ¥çš„è¯ï¼Œè¿˜å¯åœ¨åç«¯é…ç½®ç¯å¢ƒå˜é‡`WEBHOOK_URL`ä¸ºä½ çš„ Webhook åœ°å€ï¼Œåœ¨æ–°å¢è¯„è®ºæ—¶ä¼šåƒç›®æ ‡ URL å‘é€ä¸€æ¡ POST æ¶ˆæ¯ï¼Œæ¶ˆæ¯æ ¼å¼ä¸ºï¼š
```json
{
  "content": "æ¶ˆæ¯å†…å®¹"
}
```

>[!TIP]
åœ¨æ‰€æœ‰ç¯å¢ƒå˜é‡è°ƒè¯•å®Œæ¯•åå¯ç‚¹å‡»åŠ å¯†æŒ‰é’®åŠ å¯†ç¯å¢ƒå˜é‡ï¼ˆåªä¿ç•™FRONTEND_URLå’ŒS3_FOLDERï¼‰ï¼Œè¿™æ ·ä¸‹æ¬¡éƒ¨ç½²æ—¶åŠ å¯†çš„ç¯å¢ƒå˜é‡å°±ä¸ä¼šè¦†ç›–/åˆ é™¤äº†
